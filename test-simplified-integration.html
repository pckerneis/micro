<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Audio System Integration Test</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #3c3c3c;
            border-radius: 5px;
        }
        .code-editor {
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            color: #d4d4d4;
            width: 100%;
            min-height: 200px;
            resize: vertical;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        button.success {
            background: #4ec9b0;
            color: #1e1e1e;
        }
        button.danger {
            background: #f44747;
        }
        .output {
            background: #0c0c0c;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-info { color: #4ec9b0; }
        .log-warn { color: #ffcc02; }
        .log-error { color: #f44747; }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .volume-slider {
            width: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Simplified Audio System Integration Test</h1>
        <p>This page tests the complete integration of the simplified audio system with the existing GraphParser and GraphAdapter.</p>

        <div class="section">
            <h2>üéπ Code Editor</h2>
            <textarea class="code-editor" id="codeEditor">-- Simplified Audio System Test
-- Testing unified instruments and effect processing

-- Define instruments
kick = sample{url='./samples/kick.wav'}
snare = sample{url='./samples/snare.wav'}
bass = square{sustain=0, decay=0.2}
lead = sine{decay=0.1}

-- Test effect chains
bass -> lowpass{cutoff=400} -> gain{level=0.8}
lead -> delay{time=0.5} -> lowpass{cutoff=1200} -> gain{level=0.6}

-- Simple patterns
@kick [30] 1
@snare [_ 46] 1
@bass [36 _ 36 _] 1/2
@lead [60 64 67 72] 1/4</textarea>

            <div class="controls">
                <button onclick="parseCode()">Parse Code</button>
                <button onclick="playAudio()" id="playBtn">‚ñ∂ Play</button>
                <button onclick="stopAudio()">‚èπ Stop</button>
                <div class="volume-control">
                    <label>üîä</label>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="30">
                    <span id="volumeDisplay">30%</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìä System Status</h2>
            <div id="systemStatus">
                <p>Status: <span id="statusText">Not initialized</span></p>
                <p>Audio Context: <span id="audioContextStatus">Not created</span></p>
                <p>Instruments: <span id="instrumentCount">0</span></p>
                <p>Patterns: <span id="patternCount">0</span></p>
            </div>
        </div>

        <div class="section">
            <h2>üîç Parsed Graph Structure</h2>
            <div id="graphOutput" class="output">
                <em>Parse code to see graph structure...</em>
            </div>
        </div>

        <div class="section">
            <h2>üìù Console Output</h2>
            <div id="consoleOutput" class="output">
                <em>System messages will appear here...</em>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Test Results</h2>
            <div id="testResults">
                <button onclick="runSystemTests()">Run All Tests</button>
                <div id="testOutput"></div>
            </div>
        </div>
    </div>

    <!-- Load all required scripts -->
    <script src="graph-parser.js"></script>
    <script src="graph-adapter.js"></script>
    <script src="audio-graph-builder.js"></script>
    <script src="unified-instrument.js"></script>
    <script src="simplified-audio-engine.js"></script>

    <script>
        let audioEngine;
        let graphParser;
        let parsedGraph;
        let isInitialized = false;

        // Console logging override
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error
        };

        function logToOutput(message, type = 'info') {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }

        // Override console methods
        console.log = (...args) => {
            originalConsole.log(...args);
            logToOutput(args.join(' '), 'info');
        };
        console.warn = (...args) => {
            originalConsole.warn(...args);
            logToOutput(args.join(' '), 'warn');
        };
        console.error = (...args) => {
            originalConsole.error(...args);
            logToOutput(args.join(' '), 'error');
        };

        // Initialize the system
        async function initSystem() {
            if (isInitialized) return;

            try {
                // Create simplified audio engine
                audioEngine = new SimplifiedAudioEngine();
                const success = await audioEngine.init();
                
                if (!success) {
                    throw new Error('Failed to initialize audio engine');
                }

                // Create graph parser
                graphParser = new GraphParser();

                // Set up volume control
                const volumeSlider = document.getElementById('volumeSlider');
                const volumeDisplay = document.getElementById('volumeDisplay');
                
                volumeSlider.addEventListener('input', (e) => {
                    const volume = parseInt(e.target.value);
                    audioEngine.masterGain.gain.value = volume / 100;
                    volumeDisplay.textContent = `${volume}%`;
                });

                isInitialized = true;
                updateSystemStatus();
                logToOutput('‚úÖ Simplified audio system initialized successfully', 'info');

            } catch (error) {
                logToOutput(`‚ùå Initialization error: ${error.message}`, 'error');
            }
        }

        // Update system status display
        function updateSystemStatus() {
            document.getElementById('statusText').textContent = isInitialized ? 'Initialized' : 'Not initialized';
            document.getElementById('audioContextStatus').textContent = audioEngine ? 'Created' : 'Not created';
            document.getElementById('instrumentCount').textContent = audioEngine ? audioEngine.instruments.size : 0;
            document.getElementById('patternCount').textContent = audioEngine ? audioEngine.patterns.size : 0;
        }

        // Parse the code
        async function parseCode() {
            if (!isInitialized) {
                await initSystem();
            }

            try {
                const code = document.getElementById('codeEditor').value;
                parsedGraph = graphParser.parse(code);
                
                // Display parsed graph
                const graphOutput = document.getElementById('graphOutput');
                graphOutput.innerHTML = `
                    <h4>Nodes (${parsedGraph.nodes.size}):</h4>
                    <pre>${JSON.stringify(Array.from(parsedGraph.nodes.entries()), null, 2)}</pre>
                    
                    <h4>Connections (${parsedGraph.connections.length}):</h4>
                    <pre>${JSON.stringify(parsedGraph.connections, null, 2)}</pre>
                    
                    <h4>Patterns (${parsedGraph.patterns.size}):</h4>
                    <pre>${JSON.stringify(Array.from(parsedGraph.patterns.entries()), null, 2)}</pre>
                `;

                // Apply to audio engine
                audioEngine.applyParsedGraph(parsedGraph);
                updateSystemStatus();
                
                logToOutput('‚úÖ Code parsed and applied successfully', 'info');

            } catch (error) {
                logToOutput(`‚ùå Parse error: ${error.message}`, 'error');
            }
        }

        // Play audio
        function playAudio() {
            if (!isInitialized || !parsedGraph) {
                logToOutput('‚ö†Ô∏è Please parse code first', 'warn');
                return;
            }

            try {
                audioEngine.play();
                document.getElementById('playBtn').textContent = '‚è∏ Playing';
                logToOutput('‚ñ∂ Playback started', 'info');
            } catch (error) {
                logToOutput(`‚ùå Playback error: ${error.message}`, 'error');
            }
        }

        // Stop audio
        function stopAudio() {
            if (!audioEngine) return;

            try {
                audioEngine.stop();
                document.getElementById('playBtn').textContent = '‚ñ∂ Play';
                logToOutput('‚èπ Playback stopped', 'info');
            } catch (error) {
                logToOutput(`‚ùå Stop error: ${error.message}`, 'error');
            }
        }

        // Run comprehensive system tests
        async function runSystemTests() {
            if (!isInitialized) {
                await initSystem();
            }

            const testOutput = document.getElementById('testOutput');
            testOutput.innerHTML = '<h4>Running Tests...</h4>';

            const tests = [
                {
                    name: 'Audio Engine Initialization',
                    test: () => audioEngine && audioEngine.audioContext && audioEngine.masterGain
                },
                {
                    name: 'Graph Parser Creation',
                    test: () => graphParser && typeof graphParser.parse === 'function'
                },
                {
                    name: 'Code Parsing',
                    test: () => {
                        const testCode = 'kick = sample{url="test.wav"}\n@kick [30] 1';
                        const result = graphParser.parse(testCode);
                        return result.nodes.size > 0 && result.patterns.size > 0;
                    }
                },
                {
                    name: 'Instrument Creation',
                    test: () => {
                        audioEngine.addInstrument('testOsc', 'sine', { attack: 0.1 });
                        return audioEngine.instruments.has('testOsc');
                    }
                },
                {
                    name: 'Effect Chain Setting',
                    test: () => {
                        const effectChain = [{ type: 'gain', level: 0.5 }];
                        audioEngine.setInstrumentEffectChain('testOsc', effectChain);
                        const instrument = audioEngine.instruments.get('testOsc');
                        return instrument && instrument.effectChains.length > 0;
                    }
                },
                {
                    name: 'Pattern Addition',
                    test: () => {
                        audioEngine.addPattern('@test', [60, 64, 67], 0.25);
                        return audioEngine.patterns.has('@test');
                    }
                },
                {
                    name: 'Master Gain Control',
                    test: () => {
                        const originalGain = audioEngine.masterGain.gain.value;
                        audioEngine.masterGain.gain.value = 0.5;
                        const testPassed = audioEngine.masterGain.gain.value === 0.5;
                        audioEngine.masterGain.gain.value = originalGain;
                        return testPassed;
                    }
                }
            ];

            let passed = 0;
            let total = tests.length;

            for (const test of tests) {
                try {
                    const result = test.test();
                    const status = result ? '‚úÖ' : '‚ùå';
                    testOutput.innerHTML += `<div>${status} ${test.name}</div>`;
                    if (result) passed++;
                } catch (error) {
                    testOutput.innerHTML += `<div>‚ùå ${test.name} (Error: ${error.message})</div>`;
                }
            }

            testOutput.innerHTML += `<h4>Results: ${passed}/${total} tests passed</h4>`;
            
            if (passed === total) {
                logToOutput('üéâ All tests passed! Simplified audio system is working correctly.', 'info');
            } else {
                logToOutput(`‚ö†Ô∏è ${total - passed} tests failed. Check test output for details.`, 'warn');
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            logToOutput('üöÄ Simplified Audio System Integration Test loaded', 'info');
            logToOutput('Click "Parse Code" to test the system, then "Play" to hear audio', 'info');
        });
    </script>
</body>
</html>
